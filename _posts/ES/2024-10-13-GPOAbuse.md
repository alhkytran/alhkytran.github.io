---
layout: post2
language: es
title: Abusando GPO
categories: es GPO
tags:
  - Red
  - Team
  - GPOAbuse
---

## Índice
---
1. [Introducción](#Introduccion)
2. [Enumerar GPOs](#enumerar-gpos)
3. [Abusar de las GPOs](#abusar-de-las-gpos)
	2. [Sustituyendo la librería por una modificada](#sustituyendo-la-librería-por-una-modificada)

---

# Introducción

Las GPOs son las políticas de seguridad que aplican configuraciones a los objetos del directorio activo a los que aplican. Se pueden configurar para que apliquen desde fondos de pantalla, a que ejecuten scripts. Es muy útil para los administradores de sistemas ya que con una buena configuración pueden aplicar modificaciones sobre todos los usuarios y/o equipos del directorio activo .

Una mala configuración de los permisos sobre estas GPOs puede ser nefasto y llegar incluso a comprometer todo el directorio activo en pocos pasos.

# Enumerar GPOs
Para poder abusar de las GPOs es necesario, como es Obvio, poder enumerar las GPOs y ver como afecta al dominio.

Para enumerar GPOs podemos usar diferentes herramientas:

- **Ldapsearch** 

```bash
ldapsearch -H ldap://DC_IP -D 'user@dominio.local' -w 'password' -b "dc=dominio,dc=local"  "(objectClass=groupPolicyContainer)" displayName gPCFileSysPath

## En nuestro lab
ldapsearch -H ldap://10.0.0.254 -D 'rperez@brain.body' -w 'PasswordSuperChunga' -b "dc=brain,dc=body"  "(objectClass=groupPolicyContainer)" displayName gPCFileSysPath
```

<p align="center">
   <img src="/assets/img/resultado_ldap_gpo.png">
</p>

Como puede verse en la imagen, en nuestro laboratorio aparece una GPO con nombre `GPOTest` Con este tipo de enumeración debería de obtenerse las ACLs para ver que tipo de permisos existen sobre la GPO y ver que usuarios pueden realizar modificaciones sobre las GPOs

- **Bloodhound** 
Con el ingestor de bloodhound, [Bloodhound.py](https://github.com/dirkjanm/BloodHound.py), se puede realizar una enumeración completa en la que aparecerá las GPOS y los objetos que tienen permisos sobre ella

<p align="center">
   <img src="/assets/img/gpo_bloodhound1.png">
</p>
<p align="center">
   <img src="/assets/img/gpo_bloodhound2.png">
</p>
Como se puede ver en la imagen el usuario `cynops` tiene permisos sobre la GPO


# Abusar de las GPOs
Una forma que suele repetirse en referente a las GPOs es una mala configuración de permisos de las mismas o que tienen efecto sobre usuarios con mas permisos.

En nuestro ejemplo del laboratorio suponemos que hemos comprometido el usuario `cynops` este usuario tiene permisos para modificar la GPO `GPOTest` la cual afecta a una `OU` `Psicologos` que tiene un grupo `añadidor` que contiene permisos sobre un grupo `Empresas` que puede modificar `Administradores de empresas` que pueden realizar `DCSync`

Una forma de abusar de esta configuración desde `Cynops` es añadir un usuario a `Empresas` y desde ahí hacer un DCsync
<p align="center">
   <img src="/assets/img/gpo_bloodhound3.png">
</p>

Para esto usaremos [GPOabuse](https://github.com/Hackndo/pyGPOAbuse), para este ejemplo crearemos un filtro para que solo afecte cuando se loguee el usuario `aperez`y ponga en marcha toda la maquinaria, ejecutando el comando `net.exe group empresas cynops /add /domain`

```bash
pygpoabuse.py brain.body/cynops -gpo-id "7856ED7B-84FA-4393-8C72-AAB8D0C92F4F" -powershell -command "net.exe group empresas cynops /add /domain" -taskname "GPOTest2" -user -dc-ip 10.0.0.254
```

<p align="center">
   <img src="/assets/img/GPoabuse.png">
</p>

En nuestro caso se puede ver la política añadida en la ruta del `SYSVOL` donde se pueden ver las `GPOs` siempre que tengamos permisos
`/brain.body/Policies/{7856ED7B-84FA-4393-8C72-AAB8D0C92F4F}/User/Preferences/ScheduledTasks`

<p align="center">
   <img src="/assets/img/GPOadded.png">
</p>


Una vez que se aplica la política, por ejemplo logueando el usuario `aperez` que pertenece a `Psicologos`y a `añadidor`,  vemos que se ejecuta el comando puesto con el comando anterior `net.exe group empresas cynops /add /domain` por lo que al revisar el grupo vemos que el usuario `cynops` se encuentra en el grupo `Empresas`

<p align="center">
   <img src="/assets/img/Cynopswin.png">
</p>

Con esto nuestro usuario comprometido, `cynops`, obtiene permisos de usuarios `Enterprise Admins` al pertenecer al grupo `Empresas` por lo que podemos realizar un scretdump sin problemas.
<p align="center">
   <img src="/assets/img/Secretdump.png">
</p>


En nuestro ejemplo hemos añadido un usuario comprometido a un grupo a través de la aplicación de una GPO, pero se podrían ejecutar script que quisiéramos, incluso crear filtros en la política para que solo aplique un usuario en concreto, para eso necesitamos el SID del objeto del usuario

<p align="center">
   <img src="/assets/img/aperezsid.png">
</p>

Añadinendo `<Filters><FilterCollection bool="AND" not="0"><FilterUser bool="AND" not="0" name="aperez" sid="S-1-5-21-189092047-3516645198-1534806000-1110"/></FilterCollection></Filters></ImmediateTaskV2>` a la política modificada solo se aplicara sobre el usuario indicado.

<p align="center">
   <img src="/assets/img/GPOfilters.png">
</p>


---

<br>
## References
- https://github.com/Hackndo/pyGPOAbuse
- https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc739083(v=ws.10)

## Agradecimientos
- [Mario Bartolome](https://github.com/MarioBartolome) - *Por la incansable ayuda e inspiración* 
